---
title: Internet通信（二）
comments: true
date: 2018-03-02 09:53:11
updated: 2018-03-02 09:53:11
description: 上文介绍了计算机网络的基础知识和DNS域名解析，本文继续分析DNS域名解析确定接收方的IP地址后如何确定MAC地址，然后建立TCP链接。
toc: true
tags:
 - Internet
 - 计算机网络基础

---
上文介绍了计算机网络的基础知识和DNS域名解析，本文继续分析DNS域名解析确定接收方的IP地址后如何确定MAC地址，然后建立TCP链接。

我们先对上文做个小结:
- Internet通信的本质就是计算机A向计算机B发送一个数据包，后者接收再回应一个数据包，依靠传递数据包来完成Internet通信，所以确定计算机地址是Internet通信的前提。

- 在互联网中，计算机地址由IP地址和MAC地址确定，发出方的MAC地址是必然知道的，IP地址则可通过用户设置**静态IP地址**或者通过**DHCP协议**动态确定，接收方的IP地址可通过DNS解析确定，那么我们确定接受方的MAC地址，即可建立Internet通信。

## 接收方MAC地址
确定接受方MAC地址的情况分两种：发出方和接收方是否在同一子网络中。
```
如何判断发出方和接收方是否在同一子网络？
```

- 判断两台计算机是否在同一网络，需要知道双方的IP地址以及发出方本机的**子网掩码**。

- 将子网掩码和双方的IP地址转为二进制的IP地址，然后将二进制的子网掩码分别与二进制的IP地址做AND运算（两个数位都为1，运算结果为1，否则为0），然后比较结果，相同则表示在同一子网络中，否则就不在。

例如发出方的子网掩码为255.255.255.0，两台计算机IP地址分别为172.16.254.2和172.16.254.1，将子网掩码转为二进制为11111111.11111111.11111111.00000000，两台计算机IP地址转为二进制分别为10101100.00010000.11111110.00000010和10101100.00010000.11111110.00000001。两台计算机IP地分别与子网掩码做AND运算，运算结果转为十进制都是172.16.254.0，那么则表示172.16.254.2和172.16.254.1在同一子网络中。

> 在同一子网络

- 在同一子网络中的两台计算机，我们可使用**ARP协议**来确定对方的MAC地址。

- 根据**ARP协议**，发出方将在链接层发出一个ARP数据包（包含在以太网数据包中），该数据包包含本机的IP地址，MAC地址和所要查询的接收方主机IP地址，由于接收方IP地址尚未知道，则在接收方的MAC地址栏填写为FF:FF:FF:FF:FF:FF，表示为一个广播地址。

- 那么发出方所在子网络的每台计算机都会接收到这个数据包，然后从该数据包取出查询的IP地址，与自身的IP地址进行比较，如果相同，则做出响应，返回自身的MAC地址，并将发出方的IP地址和MAC地址映射添加到**本地ARP缓存**中，如果不同，则会丢弃该数据包。

- 发出方接收到接收方的响应后，会将接收方的IP地址和MAC地址映射添加到**本地ARP缓存**中，然后开始建立TCP链接通信。

注：每次查询接收方MAC地址都会在本地ARP缓存中，根据接收方的IP地址寻找相对应的MAC地址，如果没有找到，则会根据ARP协议在以太网进行广播查找。

### 查看ARP缓存表
打开命令窗口，输入arp -g或者arp -a，查看本地ARP缓存表，如图
![ARP](img/ARP.jpg)
- 本地ARP缓存表只缓存与本机在同一子网的MAC地址与IP地址，不在同一子网的就只显示默认网关的MAC地址与IP地址。

- ARP缓存类型为动态是通过ARP协议缓存的IP地址和MAC地址映射关系，缓存时间一般为两分钟，ARP缓存类型为静态则是手动设置或者默认设置的。


> 在不同子网络

两台计算机不在同一个子网络，无法直接通过**ARP协议**广播查找，那么只能通过默认网关代为转发，如图。
![gateway](img/gateway.png)

例如1号计算机与4号计算机请求通信，发送数据包，他将根据1号计算机的子网掩码判断与4号计算机是否在同一子网络中，发现不在同一子网络，于是就把这个数据包发送到网关A（网关A在计算机加入网络中已确定），网关A通过路由协议，根据路由转发表将该数据包转发至网关B，网关B再转发给4号计算机，4号计算机再做出响应，返回本机的MAC地址并添加到本地的ARP缓存。

至此，知道发出方和接收方的IP地址和MAC地址就可以建立TCP链接了。

## TCP链接



